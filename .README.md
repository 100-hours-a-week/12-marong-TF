# GCP ì¼ì¼ ë¹„ìš© ë° ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ

ë§¤ì¼ ì•„ì¹¨ ì •ê¸°ì ìœ¼ë¡œ GCP ì‚¬ìš©ëŸ‰ê³¼ ë¹„ìš©ì„ Discord Webhookì„ í†µí•´ ì•Œë¦¼ë°›ëŠ” ìë™í™” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

![Architecture Diagram](https://img.shields.io/badge/GCP-Cloud%20Functions-4285F4?style=flat-square&logo=google-cloud&logoColor=white)
![Python](https://img.shields.io/badge/Python-3.9-3776AB?style=flat-square&logo=python&logoColor=white)
![Discord](https://img.shields.io/badge/Discord-Webhook-7289DA?style=flat-square&logo=discord&logoColor=white)

## ğŸ—ï¸ ì‹œìŠ¤í…œ êµ¬ì„±

- **Cloud Functions (2ì„¸ëŒ€)**: ë¹„ìš© ë°ì´í„° ìˆ˜ì§‘ ë° ì²˜ë¦¬
- **Cloud Scheduler**: ë§¤ì¼ ì •ê¸° ì‹¤í–‰
- **BigQuery**: GCP ë¹„ìš© ë°ì´í„° ì¿¼ë¦¬
- **Cloud Monitoring**: ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
- **Discord Webhook**: ì•Œë¦¼ ì „ì†¡

## ğŸ“‹ ì‚¬ì „ ìš”êµ¬ì‚¬í•­

1. GCP í”„ë¡œì íŠ¸ ìƒì„± ë° ê²°ì œ ê³„ì • ì—°ê²°
2. Discord ì„œë²„ ë° ì±„ë„ ì¤€ë¹„
3. Google Cloud SDK (`gcloud`) ì„¤ì¹˜

## ğŸš€ ì„¤ì • ë‹¨ê³„

### 1. Discord Webhook ìƒì„±

1. Discord ì±„ë„ ì„¤ì • â†’ ì—°ë™ â†’ ì›¹í›„í¬
2. ìƒˆ ì›¹í›„í¬ ìƒì„± ë° URL ë³µì‚¬
3. Webhook URL ì €ì¥ (ë‚˜ì¤‘ì— ì‚¬ìš©)

### 2. GCP Billing Export ì„¤ì •

1. GCP Console â†’ ê²°ì œ â†’ ë¹„ìš© ê´€ë¦¬ â†’ Billing ë‚´ë³´ë‚´ê¸°
2. "ìƒì„¸ ì‚¬ìš©ëŸ‰ ë¹„ìš©" íƒ­ì—ì„œ BigQueryë¡œ ë‚´ë³´ë‚´ê¸° ì„¤ì •
3. ë°ì´í„°ì„¸íŠ¸ ìƒì„±:
   - ë°ì´í„°ì„¸íŠ¸ ID: `billing_export`
   - ìœ„ì¹˜: `asia-northeast3` (ì„œìš¸)
4. ë‚´ë³´ë‚´ê¸° í™œì„±í™”

> âš ï¸ ì£¼ì˜: Billing Export í™œì„±í™” í›„ ì•½ 24ì‹œê°„ í›„ë¶€í„° ë°ì´í„°ê°€ ìŒ“ì´ê¸° ì‹œì‘í•©ë‹ˆë‹¤.

### 3. ì„œë¹„ìŠ¤ ê³„ì • ìƒì„±

1. GCP Console â†’ IAM ë° ê´€ë¦¬ì â†’ ì„œë¹„ìŠ¤ ê³„ì •
2. ì„œë¹„ìŠ¤ ê³„ì • ë§Œë“¤ê¸°:
   - ì´ë¦„: `billing-monitoring`
   - ì„¤ëª…: `GCP ë¹„ìš© ëª¨ë‹ˆí„°ë§ìš© ì„œë¹„ìŠ¤ ê³„ì •`
3. ë‹¤ìŒ ì—­í•  ë¶€ì—¬:
   - Billing Account Viewer
   - Monitoring Viewer
   - BigQuery ë°ì´í„° ë·°ì–´
   - BigQuery ì‘ì—… ì‚¬ìš©ì

### 4. Cloud Function ë°°í¬

#### 4.1 ì½”ë“œ ì¤€ë¹„

**main.py**
```python
import os
import json
import datetime
import requests
import functions_framework
from datetime import timezone
from google.cloud import bigquery
from google.cloud import monitoring_v3

@functions_framework.http
def hello_http(request):
    """ë§¤ì¼ ì•„ì¹¨ GCP ì‚¬ìš©ëŸ‰ê³¼ ë¹„ìš©ì„ Discordë¡œ ì „ì†¡"""
    
    # í™˜ê²½ë³€ìˆ˜ì—ì„œ ì„¤ì •ê°’ ê°€ì ¸ì˜¤ê¸°
    DISCORD_WEBHOOK_URL = os.environ.get('DISCORD_WEBHOOK_URL')
    PROJECT_ID = os.environ.get('GCP_PROJECT_ID')
    BILLING_ACCOUNT_ID = os.environ.get('BILLING_ACCOUNT_ID')
    
    if not all([DISCORD_WEBHOOK_URL, PROJECT_ID, BILLING_ACCOUNT_ID]):
        return 'Missing required environment variables', 400
    
    # ì–´ì œ ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° ì¡°íšŒ
    today = datetime.date.today()
    yesterday = today - datetime.timedelta(days=1)
    
    try:
        # 1. ì¼ì¼ ë¹„ìš© ë°ì´í„° ì¡°íšŒ
        billing_data = get_daily_cost(PROJECT_ID, BILLING_ACCOUNT_ID, yesterday)
        
        # 2. ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ë°ì´í„° ì¡°íšŒ
        resource_usage = get_resource_usage(PROJECT_ID, yesterday)
        
        # 3. Discord ë©”ì‹œì§€ ìƒì„±
        message = create_discord_message(billing_data, resource_usage, yesterday)
        
        # 4. Discordë¡œ ì „ì†¡
        send_to_discord(DISCORD_WEBHOOK_URL, message)
        
        return 'Report sent successfully', 200
    except Exception as e:
        print(f"Error in hello_http: {e}")
        return f'Error: {str(e)}', 500

# ... (ì „ì²´ ì½”ë“œëŠ” repository ì°¸ì¡°)
```

**requirements.txt**
```
functions-framework
google-cloud-bigquery
google-cloud-monitoring
requests
```

#### 4.2 Function ë°°í¬

1. GCP Console â†’ Cloud Run â†’ í•¨ìˆ˜ íƒ­
2. í•¨ìˆ˜ ë§Œë“¤ê¸°:
   - í™˜ê²½: 2ì„¸ëŒ€
   - í•¨ìˆ˜ ì´ë¦„: `send-billing-report`
   - ë¦¬ì „: `asia-northeast3`
   - íŠ¸ë¦¬ê±°: HTTPS (ì¸ì¦ í•„ìš”)
3. ëŸ°íƒ€ì„ ì„¤ì •:
   - ë©”ëª¨ë¦¬: 512 MiB
   - ì œí•œ ì‹œê°„: 300ì´ˆ
   - ì„œë¹„ìŠ¤ ê³„ì •: `billing-monitoring@í”„ë¡œì íŠ¸ID.iam.gserviceaccount.com`
4. í™˜ê²½ë³€ìˆ˜ ì¶”ê°€:
   - `DISCORD_WEBHOOK_URL`: Discord Webhook URL
   - `GCP_PROJECT_ID`: GCP í”„ë¡œì íŠ¸ ID
   - `BILLING_ACCOUNT_ID`: GCP ë¹Œë§ ê³„ì • ID
5. ëŸ°íƒ€ì„: Python 3.9
6. ì§„ì…ì : `hello_http`
7. ì½”ë“œ ë¶™ì—¬ë„£ê¸° í›„ ë°°í¬

### 5. Cloud Scheduler ì„¤ì •

1. GCP Console â†’ Cloud Scheduler
2. ì‘ì—… ë§Œë“¤ê¸°:
   - ì´ë¦„: `daily-billing-report`
   - ë¦¬ì „: `asia-northeast3`
   - ë¹ˆë„: `0 9 * * *` (ë§¤ì¼ ì˜¤ì „ 9ì‹œ)
   - ì‹œê°„ëŒ€: `Asia/Seoul`
3. HTTP íƒ€ê²Ÿ:
   - URL: Cloud Function íŠ¸ë¦¬ê±° URL
   - HTTP ë©”ì„œë“œ: GET
   - Auth header: OIDC í† í° ì¶”ê°€
   - ì„œë¹„ìŠ¤ ê³„ì •: `billing-monitoring@í”„ë¡œì íŠ¸ID.iam.gserviceaccount.com`

### 6. ê¶Œí•œ ì„¤ì •

#### Cloud Run Invoker ê¶Œí•œ ë¶€ì—¬

1. Cloud Run ì½˜ì†” â†’ `send-billing-report` ì„œë¹„ìŠ¤
2. ê¶Œí•œ íƒ­ â†’ ì£¼ êµ¬ì„±ì› ì¶”ê°€
3. ìƒˆ ì£¼ êµ¬ì„±ì›: Cloud Scheduler ì„œë¹„ìŠ¤ ê³„ì •
4. ì—­í• : Cloud Run í˜¸ì¶œì
5. ì €ì¥

## ğŸ“Š Discord ë©”ì‹œì§€ ì˜ˆì‹œ

```
ğŸ“Š GCP ì¼ì¼ ë¦¬í¬íŠ¸ - 2024-11-13
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’° ì´ ë¹„ìš©
$125.45 USD

ğŸ“‹ ìƒìœ„ ë¹„ìš© ì„œë¹„ìŠ¤
â€¢ Compute Engine: $85.30
â€¢ Cloud Storage: $15.20
â€¢ BigQuery: $12.95

ğŸ–¥ï¸ CPU ì‚¬ìš©ë¥         ğŸ’¾ Storage ì‚¬ìš©ëŸ‰    ğŸ—„ï¸ Cloud SQL ë©”ëª¨ë¦¬
í‰ê· : 45.2%         1,250.5 GB          í‰ê· : 68.3%
ìµœëŒ€: 78.9%
```

## ğŸ”§ ë¬¸ì œ í•´ê²°

### 403 Permission Denied ì˜¤ë¥˜
- Cloud Run Invoker ê¶Œí•œì´ Cloud Scheduler ì„œë¹„ìŠ¤ ê³„ì •ì— ë¶€ì—¬ë˜ì—ˆëŠ”ì§€ í™•ì¸
- OIDC í† í°ì´ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸

### BigQuery ë°ì´í„° ì—†ìŒ
- Billing Export í™œì„±í™” í›„ 24ì‹œê°„ ëŒ€ê¸° í•„ìš”
- `billing_export` ë°ì´í„°ì„¸íŠ¸ê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸

### Function ë°°í¬ ì‹¤íŒ¨
- Python í•¨ìˆ˜ëª…ì— í•˜ì´í”ˆ(-) ì‚¬ìš© ë¶ˆê°€
- ì§„ì…ì ê³¼ í•¨ìˆ˜ëª…ì´ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
- requirements.txt ë¬¸ë²• í™•ì¸

## ğŸ” ëª¨ë‹ˆí„°ë§

### Cloud Function ë¡œê·¸ í™•ì¸
```bash
gcloud functions logs read send-billing-report --limit 50
```

### Cloud Scheduler í…ŒìŠ¤íŠ¸
1. Cloud Scheduler ì½˜ì†”ì—ì„œ ì‘ì—… ì„ íƒ
2. "ì§€ê¸ˆ ì‹¤í–‰" ë²„íŠ¼ í´ë¦­
3. Discord ì±„ë„ì—ì„œ ë©”ì‹œì§€ í™•ì¸

## ğŸ“ ì¶”ê°€ ê¸°ëŠ¥ ì•„ì´ë””ì–´

- [ ] ì˜ˆì‚° ì´ˆê³¼ ì•Œë¦¼
- [ ] ì „ì¼ ëŒ€ë¹„ ë¹„ìš© ë¹„êµ
- [ ] ì›”ë§ ì˜ˆìƒ ë¹„ìš© ê³„ì‚°
- [ ] ë¹„ì •ìƒì ì¸ ë¹„ìš© ì¦ê°€ ê°ì§€
- [ ] ì„œë¹„ìŠ¤ë³„ ìƒì„¸ ë¶„ì„ ë¦¬í¬íŠ¸

## ğŸ¤ ê¸°ì—¬í•˜ê¸°

1. Fork the Project
2. Create your Feature Branch (`git checkout -b feature/AmazingFeature`)
3. Commit your Changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the Branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request

## ğŸ“„ ë¼ì´ì„ ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” MIT ë¼ì´ì„ ìŠ¤ í•˜ì— ë°°í¬ë©ë‹ˆë‹¤.

## ğŸ“ ë¬¸ì˜ì‚¬í•­

í”„ë¡œì íŠ¸ì— ëŒ€í•œ ë¬¸ì˜ì‚¬í•­ì´ë‚˜ ì œì•ˆì´ ìˆìœ¼ì‹œë‹¤ë©´ Issueë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.

---
â­ ì´ í”„ë¡œì íŠ¸ê°€ ë„ì›€ì´ ë˜ì—ˆë‹¤ë©´ Starë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”!